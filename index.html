<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.css">
  <title>Document</title>
  <style>
    .postItem {
      border-bottom: 1px solid #428BCA;
      margin-bottom: 10px;
      /*padding-bottom: 5px;*/
    }
    .post {
      /*background-color: #4FA;*/
    }
  </style>
  <script type="text/javascript" src="bower_components/react/JSXTransformer.js"></script>
  <script type="text/javascript" src="bower_components/react/react.js"></script>
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.js"></script>
</head>
<body>
  <div id="mountArea" class="container">
    <center>
      <br><br>
      <h1>Loading...</h1>
    </center>
  </div>
  <script type="text/jsx" charset="utf-8">
  /** @jsx React.DOM */
    console.clear();
    //jq '.data.children[].data | {title: .title, domain: .domain, link: .url, category: .link_flair_text}' -- worldnews.json

    var serverUrl = "server/";
    var redditUrl = "http://www.reddit.com/r/worldnews.json";
    if(location.href.indexOf('local') !== -1) {
      redditUrl = serverUrl + 'worldnews.json';
    }

    var PostInfo = React.createClass({
      render: function() {
        // return ()
      }
    });

    var Post = React.createClass({
      getInitialState: function() {
        return {
          loading: false,
          error: false,
          open: false,
          content: null
        };
      },
      closeArticle: function() {
        this.setState({loading: false, open: false, error: false, content: null});
        return false;
      },
      getArticle: function(articleLink, forceReload, callback) {
        var articleLink = serverUrl + "?url=" + articleLink;
        if(forceReload) {
          articleLink = articleLink + "&force-reload=true";
        }
        $.getJSON(articleLink, function(data) {
          callback(data);
        }.bind(this));
      },
      forceReload: function() {
        var post = this.props.data;
        this.setState({loading: true, content: "Loading..."});
        this.getArticle(post.link, true, function(data) {
          // this.setState({open: true});
          if(data.content === undefined) {
            this.setState({error: true, content: data.messages});
          } else {
            this.setState({error: false, content: data.content});
          }
        }.bind(this));
        return false;
      },
      readArticle: function() {
        var post = this.props.data;
        this.setState({loading: true, content: "Loading...", open: true});
        this.getArticle(post.link, false, function(data) {
          // this.setState({open: true});
          if(data.content === undefined) {
            this.setState({error: true, content: data.messages});
          } else {
            this.setState({error: false, content: data.content});
          }
        }.bind(this));
        return false;
      },
      render: function() {
          var post = this.props.data;
          var closeBtnStyle = {
            position: 'fixed',
            top: '5',
            left: '5'
          };
          return (
            <div>
              <p>
                <h5>{post.title}</h5>
                <span className={this.state.open ? 'hidden' : ''}>
                  <a className="btn btn-primary" href="" onClick={this.readArticle}>
                    <span className="glyphicon glyphicon-chevron-down"></span>
                    &nbsp;
                    Read
                  </a>
                </span>
                <span className={this.state.open ? '' : 'hidden'}>
                  <a className="btn btn-primary" href="" onClick={this.closeArticle}>
                    <span className="glyphicon glyphicon-chevron-up"></span>
                    &nbsp;
                    Close
                  </a>
                </span>
                &nbsp;
                <a className="btn btn-info" href={post.link} target="_blank">
                  <span className="glyphicon glyphicon-link"></span>
                  &nbsp;
                  Source
                </a>
                &nbsp;
                <span className="label label-primary">
                  <span className="glyphicon glyphicon-globe"></span>
                  &nbsp;
                  {post.domain}
                </span>
                &nbsp;
                <span className={post.category ? "badge" : "hidden"}>
                  <span className="glyphicon glyphicon-tag"></span>
                  &nbsp;
                  {post.category}
                </span>
              </p>
              <div className={this.state.loading ? 'well' : 'post'}>
                <div className={this.state.open ? '' : 'hidden'}>
                  <a className="btn btn-warning" onClick={this.forceReload} target="_blank">
                    <span className="glyphicon glyphicon-refresh"></span>
                    &nbsp;
                    Force-Reload
                  </a>
                  &nbsp;
                  <a className="btn btn-default" href={post.comments} target="_blank">
                    <span className="glyphicon glyphicon-comment"></span>
                    &nbsp;
                    Comments
                  </a>
                </div>
                <div className={this.state.error ? 'alert alert-danger' : 'hidden'}>
                  <h1>Error!</h1>
                  { this.state.content }
                </div>
                <div className={this.state.error ? 'hidden' : ''}>
                  <span className={this.state.open ? '' : 'hidden'}>
                    <h2>{post.title}</h2>
                    <div dangerouslySetInnerHTML={{__html: this.state.content}} />
                  </span>
                </div>
              </div>
            </div>
          )
      }
    });

    var AllPosts = React.createClass({
        getInitialState: function() {
          return {posts: this.props.data}
        },
        render: function() {
          var posts = this.state.posts.map(function(data, i) {
            return (
              <div className="postItem">
                <Post data={data}/>
              </div>
            )
          });
          return (
            <div>
              <h1>
                <span className="glyphicon glyphicon-globe"></span>
                &nbsp;
                WorldNews
              </h1>
              {posts}
            </div>
          );
        }
    });

    $.getJSON(redditUrl, function(data) {
        var allPosts = [];
        var posts = data.data.children
        posts.forEach(function(post) {
            var d = post.data;
            var story = {
              title: d.title,
              domain: d.domain,
              comments: 'http://www.reddit.com' + d.permalink,
              link: d.url,
              category: d.link_flair_text
            };
            allPosts.push(story);
        })
        React.renderComponent(<AllPosts data={allPosts}/>, document.getElementById('mountArea'));
    });

  </script>
</body>
</html>
